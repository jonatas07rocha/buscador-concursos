<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Concursos</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#111827">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fontes do Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background-color: #1f2937; color: #d1d5db; border: 1px solid #374151; }
        .leaflet-popup-content a { color: #60a5fa; }
        .toggle-btn-active { background-color: #3b82f6; color: #ffffff; }
        input[type="search"]::-webkit-search-cancel-button { -webkit-appearance:none; }
        
        /* Estilos para vagas marcadas e favoritadas */
        .vaga-marcada { opacity: 0.5; }
        .vaga-marcada h3, .vaga-marcada p { text-decoration: line-through; }
        .favorite-btn.favorited svg { fill: #facc15; color: #facc15; } /* Amarelo para favorito */

        @media (min-width: 768px) {
            #map-container, #lista-container { height: 100vh; }
        }
    </style>
</head>
<body class="text-gray-200">

    <div id="app" class="flex flex-col md:flex-row h-screen bg-gray-900">
        
        <!-- Painel Lateral -->
        <div id="lista-container" class="w-full md:w-2/5 lg:w-1/3 bg-gray-900 flex flex-col h-full">
            <header class="p-4 border-b border-gray-700 bg-gray-900">
                <h1 class="text-2xl font-bold text-white">Buscador de Concursos</h1>
                <div id="stats" class="text-sm text-gray-400 mt-2 space-y-1"></div>
                <div class="mt-4 relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    </div>
                    <input type="search" id="search-bar" placeholder="Pesquisar por cargo, órgão, local..." class="block w-full pl-10 pr-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-gray-300 placeholder-gray-400 focus:outline-none focus:bg-gray-700 focus:border-blue-500">
                </div>
                <!-- Filtros e Classificação -->
                <div class="flex space-x-2 mt-3">
                    <div class="flex-1">
                        <label for="sort-by" class="sr-only">Classificar por</label>
                        <select id="sort-by" class="w-full text-sm py-2 pl-3 pr-8 bg-gray-800 border-gray-600 rounded-md focus:outline-none focus:border-blue-500">
                            <option value="padrao">Classificação Padrão</option>
                            <option value="favoritos">Mostrar Favoritos</option>
                            <option value="estado">Estado (A-Z)</option>
                            <option value="municipio">Município (A-Z)</option>
                            <option value="cargo">Cargo (A-Z)</option>
                        </select>
                    </div>
                    <button id="filter-uf-btn" class="text-sm py-2 px-4 bg-gray-800 border-gray-600 rounded-md hover:bg-gray-700">Filtrar por UF</button>
                </div>
                <!-- Seção de Backup e Restauração -->
                <div class="flex space-x-2 mt-3 border-t border-gray-700 pt-3">
                    <button id="export-btn" class="flex items-center justify-center flex-1 text-sm py-2 px-4 bg-green-800 hover:bg-green-700 rounded-md font-semibold transition-colors">
                        <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                        <span>Fazer Backup</span>
                    </button>
                    <label for="import-input" class="flex items-center justify-center flex-1 text-sm py-2 px-4 bg-yellow-700 hover:bg-yellow-600 text-gray-900 rounded-md cursor-pointer text-center font-semibold transition-colors">
                        <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                        <span>Restaurar Backup</span>
                    </label>
                    <input type="file" id="import-input" class="hidden" accept=".json"/>
                </div>
            </header>
            
            <div id="lista-vagas" class="overflow-y-auto custom-scrollbar flex-grow p-2 md:p-4 pb-20"></div>
        </div>
        
        <!-- Mapa -->
        <div id="map-container" class="w-full md:w-3/5 lg:w-2/3 hidden md:block h-full">
            <div id="map" class="w-full h-full z-0"></div>
        </div>
    </div>

    <!-- Navegação Mobile -->
    <div id="mobile-nav" class="fixed bottom-0 left-0 right-0 bg-gray-800 p-2 flex justify-around md:hidden z-30 border-t border-gray-700">
        <button id="toggle-list" class="toggle-btn-active flex-1 text-center py-2 px-4 rounded-md font-semibold">Lista</button>
        <button id="toggle-map" class="flex-1 text-center py-2 px-4 rounded-md font-semibold text-gray-300">Mapa</button>
    </div>

    <!-- Modal de Filtro UF -->
    <div id="uf-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 max-w-md">
            <h3 class="text-xl font-semibold mb-4">Filtrar por Estado (UF)</h3>
            <div id="uf-checkboxes" class="grid grid-cols-3 sm:grid-cols-4 gap-2 max-h-64 overflow-y-auto custom-scrollbar"></div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="clear-uf-filter" class="px-4 py-2 text-sm rounded-md bg-gray-600 hover:bg-gray-500">Limpar</button>
                <button id="apply-uf-filter" class="px-4 py-2 text-sm rounded-md bg-blue-600 hover:bg-blue-500">Aplicar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos da UI
            const elements = {
                listaVagas: document.getElementById('lista-vagas'),
                stats: document.getElementById('stats'),
                searchBar: document.getElementById('search-bar'),
                sortBy: document.getElementById('sort-by'),
                filterUfBtn: document.getElementById('filter-uf-btn'),
                toggleListBtn: document.getElementById('toggle-list'),
                toggleMapBtn: document.getElementById('toggle-map'),
                ufModal: document.getElementById('uf-modal'),
                ufCheckboxes: document.getElementById('uf-checkboxes'),
                clearUfFilterBtn: document.getElementById('clear-uf-filter'),
                applyUfFilterBtn: document.getElementById('apply-uf-filter'),
                map: L.map('map', { attributionControl: false }).setView([-14.235, -51.925], 4),
                exportBtn: document.getElementById('export-btn'),
                importInput: document.getElementById('import-input')
            };

            // Estado da aplicação
            let state = {
                allVagas: [],
                markers: [],
                debounceTimer: null,
                markedVagaIds: new Set(),
                favoritedVagaIds: new Set(),
                selectedUfs: new Set()
            };

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(elements.map);

            // --- Gerenciamento de Estado (LocalStorage) ---
            const MARKED_STORAGE_KEY = 'markedVagaIds';
            const FAVORITE_STORAGE_KEY = 'favoritedVagaIds';

            function loadStateFromStorage() {
                const storedMarked = localStorage.getItem(MARKED_STORAGE_KEY);
                state.markedVagaIds = new Set(storedMarked ? JSON.parse(storedMarked) : []);
                const storedFavorited = localStorage.getItem(FAVORITE_STORAGE_KEY);
                state.favoritedVagaIds = new Set(storedFavorited ? JSON.parse(storedFavorited) : []);
            }

            function saveMarkedVagasToStorage() {
                localStorage.setItem(MARKED_STORAGE_KEY, JSON.stringify([...state.markedVagaIds]));
            }
            function saveFavoritedVagasToStorage() {
                localStorage.setItem(FAVORITE_STORAGE_KEY, JSON.stringify([...state.favoritedVagaIds]));
            }

            function getVagaId(vaga) {
                return `${vaga.orgao}|${vaga.cargo}`;
            }
            
            // --- Lógica de Atualização de Estatísticas ---
            function updateStats() {
                const totalVagas = state.allVagas.length;
                const totalFavorited = state.favoritedVagaIds.size;
                
                // Uma vaga é considerada "vista" se foi favoritada OU arquivada.
                // O Set garante que, se uma vaga for as duas coisas, ela seja contada apenas uma vez.
                const viewedVagaIds = new Set([...state.favoritedVagaIds, ...state.markedVagaIds]);
                const totalPending = totalVagas - viewedVagaIds.size;

                elements.stats.innerHTML = `
                    <p>
                        <strong class="font-semibold text-white">${totalVagas}</strong> vagas totais | 
                        <strong class="font-semibold text-blue-400">${totalPending}</strong> pendentes |
                        <strong class="font-semibold text-yellow-400">${totalFavorited}</strong> favoritas
                    </p>
                    <p>Última atualização: <span class="font-semibold text-white" id="last-update-time"></span></p>
                `;
            }

            // --- Lógica Principal de Renderização ---
            async function initializeApp() {
                loadStateFromStorage();
                try {
                    const response = await fetch('dados/vagas.json');
                    if (!response.ok) throw new Error('Falha ao carregar vagas.json');
                    const data = await response.json();
                    
                    state.allVagas = data.vagas.map(vaga => {
                        const id = getVagaId(vaga);
                        return {
                            ...vaga,
                            id: id,
                            isMarked: state.markedVagaIds.has(id),
                            isFavorited: state.favoritedVagaIds.has(id)
                        };
                    });
                    
                    updateStats(); // Atualiza todas as estatísticas
                    document.getElementById('last-update-time').textContent = data.data_extracao;
                    
                    populateUfFilterModal();
                    updateDisplay();
                    lucide.createIcons(); // Renderiza os ícones Lucide
                } catch (error) {
                    console.error("Erro ao carregar dados:", error);
                    elements.listaVagas.innerHTML = `<div class="m-4 p-4 bg-red-900/50 text-red-300 rounded-md"><strong>Erro:</strong> Não foi possível carregar os dados.</div>`;
                }
            }

            function updateDisplay() {
                // 1. Filtrar
                let filteredVagas = state.allVagas.filter(vaga => {
                    const searchTerm = normalizeText(elements.searchBar.value);
                    const matchesSearch = searchTerm === '' || 
                        normalizeText(vaga.cargo).includes(searchTerm) ||
                        normalizeText(vaga.orgao).includes(searchTerm) ||
                        normalizeText(vaga.municipio).includes(searchTerm);
                    
                    const matchesUf = state.selectedUfs.size === 0 || state.selectedUfs.has(vaga.uf);
                    
                    const sortValue = elements.sortBy.value;
                    const matchesFavorite = sortValue !== 'favoritos' || vaga.isFavorited;

                    return matchesSearch && matchesUf && matchesFavorite;
                });

                // 2. Classificar
                const sortValue = elements.sortBy.value;
                if (sortValue !== 'padrao' && sortValue !== 'favoritos') {
                    filteredVagas.sort((a, b) => (a[sortValue] || '').localeCompare(b[sortValue] || ''));
                }

                // 3. Particionar e Mover Marcados para o Final
                const unmarked = filteredVagas.filter(v => !v.isMarked);
                const marked = filteredVagas.filter(v => v.isMarked);
                const finalVagasToRender = [...unmarked, ...marked];

                renderVagas(finalVagasToRender);
            }

            function renderVagas(vagas) {
                elements.listaVagas.innerHTML = '';
                state.markers.forEach(marker => elements.map.removeLayer(marker));
                state.markers = [];

                if (vagas.length === 0) {
                    elements.listaVagas.innerHTML = `<div class="p-4 text-center text-gray-400">Nenhuma vaga encontrada.</div>`;
                    return;
                }

                vagas.forEach(vaga => {
                    // Adicionar Marcador
                    if (vaga.lat && vaga.lng) {
                        const lat = parseFloat(vaga.lat), lng = parseFloat(vaga.lng);
                        if (!isNaN(lat) && !isNaN(lng)) {
                            const marker = L.marker([lat, lng], { vagaId: vaga.id, opacity: vaga.isMarked ? 0.6 : 1.0 });
                            marker.bindPopup(`<div class="text-sm font-sans"><strong class="text-base text-blue-300">${vaga.cargo}</strong><br><strong>Órgão:</strong> ${vaga.orgao}<br><strong>Local:</strong> ${vaga.municipio} - ${vaga.uf}<br><a href="${vaga.link_orgao}" target="_blank" class="font-semibold mt-2 block">Acessar página &rarr;</a></div>`);
                            state.markers.push(marker);
                            marker.addTo(elements.map);
                        }
                    }

                    // Criar Card
                    const vagaEl = document.createElement('div');
                    vagaEl.className = `bg-gray-800 border border-gray-700 rounded-lg p-4 mb-3 mx-2 md:mx-0 hover:bg-gray-700/50 transition-colors duration-200 cursor-pointer ${vaga.isMarked ? 'vaga-marcada' : ''}`;
                    
                    let localInfo = vaga.municipio !== 'N/D' ? `${vaga.municipio} - ${vaga.uf}` : vaga.uf;

                    vagaEl.innerHTML = `
                        <div class="flex items-start">
                            <div class="flex-1">
                                <h3 class="font-semibold text-lg text-blue-400">${vaga.cargo}</h3>
                                <p class="text-sm text-gray-300 mt-1">${vaga.orgao}</p>
                            </div>
                            <div class="flex items-center space-x-3 ml-4">
                                <button class="favorite-btn ${vaga.isFavorited ? 'favorited' : ''}" title="Marcar como favorito">
                                    <svg class="w-6 h-6 text-gray-500 stroke-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                                </button>
                                <input type="checkbox" ${vaga.isMarked ? 'checked' : ''} class="h-5 w-5 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-3">
                           <span class="text-xs font-medium bg-blue-900/50 text-blue-300 px-2.5 py-1 rounded-full">${localInfo}</span>
                           <a href="${vaga.link_orgao}" target="_blank" class="text-sm text-blue-400 hover:underline">Ver Edital &rarr;</a>
                        </div>
                    `;
                    
                    // Eventos
                    const checkbox = vagaEl.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('click', e => {
                        e.stopPropagation();
                        vaga.isMarked = e.target.checked;
                        if (vaga.isMarked) state.markedVagaIds.add(vaga.id); else state.markedVagaIds.delete(vaga.id);
                        saveMarkedVagasToStorage();
                        updateStats();
                        updateDisplay();
                    });

                    const favoriteBtn = vagaEl.querySelector('.favorite-btn');
                    favoriteBtn.addEventListener('click', e => {
                        e.stopPropagation();
                        vaga.isFavorited = !vaga.isFavorited;
                        if (vaga.isFavorited) state.favoritedVagaIds.add(vaga.id); else state.favoritedVagaIds.delete(vaga.id);
                        saveFavoritedVagasToStorage();
                        favoriteBtn.classList.toggle('favorited');
                        updateStats();
                    });

                    const marker = state.markers.find(m => m.options.vagaId === vaga.id);
                    if (marker) {
                        vagaEl.addEventListener('click', () => {
                            elements.map.flyTo(marker.getLatLng(), 11);
                            setTimeout(() => marker.openPopup(), 800);
                            if (window.innerWidth < 768) showMapView();
                        });
                        vagaEl.addEventListener('mouseover', () => {
                            if (window.innerWidth >= 768) elements.map.flyTo(marker.getLatLng(), 11);
                        });
                    }
                    elements.listaVagas.appendChild(vagaEl);
                });
            }

            function populateUfFilterModal() {
                const ufs = [...new Set(state.allVagas.map(v => v.uf))].filter(uf => uf !== 'N/D').sort();
                elements.ufCheckboxes.innerHTML = ufs.map(uf => `<label class="flex items-center space-x-2 text-sm"><input type="checkbox" value="${uf}" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500"><span>${uf}</span></label>`).join('');
            }

            function normalizeText(text) {
                return text ? text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : '';
            }

            // --- Handlers de Eventos ---
            elements.searchBar.addEventListener('input', () => { clearTimeout(state.debounceTimer); state.debounceTimer = setTimeout(updateDisplay, 300); });
            elements.sortBy.addEventListener('change', updateDisplay);
            elements.filterUfBtn.addEventListener('click', () => elements.ufModal.classList.remove('hidden'));
            elements.ufModal.addEventListener('click', e => { if (e.target === elements.ufModal) elements.ufModal.classList.add('hidden'); });
            elements.applyUfFilterBtn.addEventListener('click', () => { state.selectedUfs.clear(); elements.ufCheckboxes.querySelectorAll('input:checked').forEach(input => state.selectedUfs.add(input.value)); elements.ufModal.classList.add('hidden'); updateDisplay(); });
            elements.clearUfFilterBtn.addEventListener('click', () => { elements.ufCheckboxes.querySelectorAll('input:checked').forEach(input => input.checked = false); state.selectedUfs.clear(); elements.ufModal.classList.add('hidden'); updateDisplay(); });
            
            function showMapView() { document.getElementById('lista-container').classList.add('hidden'); document.getElementById('map-container').classList.remove('hidden'); elements.toggleMapBtn.classList.add('toggle-btn-active'); elements.toggleListBtn.classList.remove('toggle-btn-active'); setTimeout(() => elements.map.invalidateSize(), 100); }
            function showListView() { document.getElementById('lista-container').classList.remove('hidden'); document.getElementById('map-container').classList.add('hidden'); elements.toggleListBtn.classList.add('toggle-btn-active'); elements.toggleMapBtn.classList.remove('toggle-btn-active'); }

            elements.toggleListBtn.addEventListener('click', showListView);
            elements.toggleMapBtn.addEventListener('click', showMapView);
            
            // --- LÓGICA DE BACKUP E RESTAURAÇÃO ---
            elements.exportBtn.addEventListener('click', () => {
                try {
                    const markedVagas = localStorage.getItem(MARKED_STORAGE_KEY);
                    const favoritedVagas = localStorage.getItem(FAVORITE_STORAGE_KEY);

                    if (!markedVagas && !favoritedVagas) {
                        alert('Nenhum dado para fazer backup.');
                        return;
                    }

                    const backupData = {
                        markedVagaIds: markedVagas ? JSON.parse(markedVagas) : [],
                        favoritedVagaIds: favoritedVagas ? JSON.parse(favoritedVagas) : []
                    };

                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    
                    const date = new Date();
                    const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    a.href = url;
                    a.download = `backup-concursos-${dateString}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert('Backup exportado com sucesso!');
                } catch (error) {
                    console.error("Erro ao exportar dados:", error);
                    alert('Ocorreu um erro ao tentar exportar os dados.');
                }
            });

            elements.importInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);

                        if (backupData.markedVagaIds !== undefined && backupData.favoritedVagaIds !== undefined) {
                            localStorage.setItem(MARKED_STORAGE_KEY, JSON.stringify(backupData.markedVagaIds));
                            localStorage.setItem(FAVORITE_STORAGE_KEY, JSON.stringify(backupData.favoritedVagaIds));

                            alert('Backup restaurado com sucesso! A página será recarregada para aplicar as alterações.');
                            location.reload(); // Recarrega a página para que o estado seja atualizado
                        } else {
                            throw new Error('Formato de arquivo inválido.');
                        }
                    } catch (error) {
                        console.error("Erro ao importar dados:", error);
                        alert('Erro ao ler o arquivo de backup. Verifique se o arquivo é válido.');
                    }
                };
                reader.readAsText(file);
                
                elements.importInput.value = ''; // Limpa o input
            });

            initializeApp();
        });

        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/service-worker.js'); }); }
    </script>
</body>
</html>

