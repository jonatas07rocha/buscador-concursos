<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Vagas :: Análise Geográfica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Paleta de Cores Futurista */
            --color-bg: #0d1117; /* Fundo principal (quase preto) */
            --color-panel-bg: #161b22; /* Fundo dos painéis */
            --color-primary: #30b4f0; /* Azul elétrico/ciano para destaque */
            --color-primary-glow: rgba(48, 180, 240, 0.5); /* Cor para o efeito de "brilho" */
            --color-secondary: #c9d1d9; /* Texto principal (cinza claro) */
            --color-text: #8b949e;   /* Texto secundário (cinza mais escuro) */
            --color-border: #30363d; /* Cor da borda */
            --font-body: 'Roboto Mono', monospace;
            --font-mono: 'Roboto Mono', monospace;
        }
        body { 
            font-family: var(--font-body);
            background-color: var(--color-bg);
            color: var(--color-text);
            /* Efeito de grade no fundo */
            background-image: 
                linear-gradient(var(--color-border) 1px, transparent 1px), 
                linear-gradient(to right, var(--color-border) 1px, var(--color-bg) 1px);
            background-size: 40px 40px;
        }
        .panel {
            background-color: var(--color-panel-bg);
            border: 1px solid var(--color-border);
            /* Sombra para dar profundidade e um leve brilho neon */
            box-shadow: 0 0 15px rgba(0,0,0,0.3), 0 0 5px var(--color-primary-glow);
            border-radius: 0.5rem;
            backdrop-filter: blur(10px); /* Efeito de "vidro fosco" se o fundo tivesse imagem */
        }
        h1, h2 { font-family: var(--font-mono); }
        h1 { 
            color: var(--color-secondary); 
            font-weight: 700;
            /* Efeito de texto neon */
            text-shadow: 0 0 8px var(--color-primary-glow);
        }
        h2 { 
            color: var(--color-primary); 
            font-weight: 500;
        }
        .monospace { font-family: var(--font-mono); }
        input[type="text"] { 
            background: var(--color-bg); 
            border: 1px solid var(--color-border); 
            color: var(--color-secondary);
            transition: all 0.3s ease;
        }
        input[type="text"]:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(48, 180, 240, 0.2);
            background-color: var(--color-panel-bg);
            outline: none;
        }
        /* Foco na tabela com brilho neon */
        .table-row-focus { 
            background-color: rgba(48, 180, 240, 0.1) !important; 
            border-left: 3px solid var(--color-primary);
            box-shadow: inset 0 0 10px var(--color-primary-glow);
            color: var(--color-secondary);
        }
        /* Tema escuro para o mapa */
        .leaflet-container { 
            background: #2d333b; 
            border-radius: 0.5rem; 
        }
        /* Tema escuro para a barra de rolagem */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-panel-bg); }
        ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: var(--color-primary); }
        
        /* Ícone de mira (Crosshair) redesenhado */
        .crosshair-icon {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .crosshair-icon::before, .crosshair-icon::after {
            content: '';
            position: absolute;
            background-color: var(--color-primary);
            box-shadow: 0 0 8px var(--color-primary-glow);
            border-radius: 1px;
        }
        .crosshair-icon::before { width: 1px; height: 32px; }
        .crosshair-icon::after { width: 32px; height: 1px; }
        .crosshair-dot {
            width: 6px;
            height: 6px;
            background-color: var(--color-bg);
            border: 1px solid var(--color-primary);
            border-radius: 50%;
            z-index: 1;
            animation: pulse 1.5s infinite;
        }
        /* Animação de pulso para o marcador */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 var(--color-primary-glow); }
            70% { box-shadow: 0 0 0 10px rgba(48, 180, 240, 0); }
            100% { box-shadow: 0 0 0 0 rgba(48, 180, 240, 0); }
        }
    </style>
</head>
<body class="text-slate-400">
    <div class="p-4 sm:p-6 lg:p-8">
        <div class="container mx-auto">
            <header class="text-center mb-10">
                <h1 class="text-3xl md:text-5xl">Painel de Vagas</h1>
                <p class="mt-2 monospace text-sm">Dados extraídos do PCI Concursos</p>
                <p id="last-updated" class="text-xs mt-2 monospace"></p>
            </header>
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <!-- Coluna do Mapa -->
                <section class="lg:col-span-3 panel p-4">
                    <h2 class="text-xl mb-4 flex items-center gap-2"><i data-lucide="map-pin"></i>Localização da Vaga</h2>
                    <div id="map" class="h-96 lg:h-[600px] w-full z-0 rounded-lg"></div>
                </section>
                <!-- Coluna da Lista de Vagas -->
                <section class="lg:col-span-2 panel p-4 flex flex-col">
                    <h2 class="text-xl mb-4 flex items-center gap-2"><i data-lucide="list-filter"></i>Vagas Encontradas (<span id="vaga-count">0</span>)</h2>
                    <div class="relative mb-4">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500"></i>
                        <input type="text" id="filterInput" class="w-full pl-10 pr-4 py-2 rounded-md transition" placeholder="Filtrar por cargo, órgão, etc...">
                    </div>
                    <div id="table-wrapper" class="overflow-y-auto flex-grow h-[524px] relative" tabindex="0">
                        <table class="w-full text-left">
                            <tbody id="resultsBody"></tbody>
                        </table>
                        <p id="noResultsMessage" class="text-center p-6" style="display: none;">Nenhum resultado encontrado.</p>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Os dados e coordenadas serão injetados aqui pelo script Python
            const data = __DATA_PLACEHOLDER__;
            const municipiosCoords = __MUNICIPIOS_COORDS_PLACEHOLDER__;
            
            let map;
            let selectionMarker = null;

            // Sons futuristas
            const sfx = {
                synth: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 } }).toDestination(),
                keySynth: new Tone.FMSynth({
                    harmonicity: 8,
                    modulationIndex: 2,
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.1 },
                    modulation: { type: 'square' },
                    modulationEnvelope: { attack: 0.002, decay: 0.2, sustain: 0, release: 0.1 }
                }).toDestination(),
                playBoot: () => sfx.synth.triggerAttackRelease("C2", "8n", Tone.now()),
                playKey: () => sfx.keySynth.triggerAttackRelease("G5", "32n", Tone.now(), 0.5),
                playHover: () => sfx.keySynth.triggerAttackRelease("C5", "32n", Tone.now(), 0.3),
                playSelect: () => sfx.synth.triggerAttackRelease("A3", "16n", Tone.now())
            };
            const startAudio = () => { if (Tone.context.state !== 'running') { Tone.start(); sfx.playBoot(); document.body.removeEventListener('click', startAudio); document.body.removeEventListener('keydown', startAudio); }};
            document.body.addEventListener('click', startAudio);
            document.body.addEventListener('keydown', startAudio);

            const resultsBody = document.getElementById('resultsBody');
            const tableWrapper = document.getElementById('table-wrapper');
            const filterInput = document.getElementById('filterInput');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const lastUpdatedEl = document.getElementById('last-updated');
            const vagaCountEl = document.getElementById('vaga-count');
            
            function renderAll() {
                if (!data || !data.vagas || typeof data.vagas === 'undefined') {
                    console.error("Dados de vagas ausentes ou em formato incorreto.");
                    vagaCountEl.textContent = 'ERRO';
                    return;
                }
                lastUpdatedEl.textContent = `Última Sincronização: ${data.data_extracao}`;
                vagaCountEl.textContent = data.total_vagas;
                initializeMap();
                displayTable(data.vagas);
                lucide.createIcons();
            }

            function initializeMap() {
                map = L.map('map', { zoomControl: false }).setView([-14.235, -51.925], 4.5);
                // Tile layer com tema escuro
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>' 
                }).addTo(map);
            }
            
            function focusMapOnLocation(vaga) {
                if(!map) return;
                
                // Remove o marcador anterior
                if (selectionMarker) {
                    map.removeLayer(selectionMarker);
                    selectionMarker = null;
                }

                // Chave para buscar a coordenada
                const municipioLimpo = vaga.municipio.replace(/ /g, '-').toLowerCase();
                const key = `${municipioLimpo}-${vaga.uf.toLowerCase()}`;
                const municipioCoord = municipiosCoords[key];
                
                // A MÁGICA ACONTECE AQUI:
                // Se 'municipioCoord' for encontrado (ou seja, não for "N/D"), então move o mapa.
                if (municipioCoord) {
                    const crosshairIcon = L.divIcon({
                        className: 'crosshair-icon',
                        html: '<div class="crosshair-dot"></div>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    selectionMarker = L.marker(municipioCoord, { 
                        icon: crosshairIcon,
                        interactive: false 
                    }).addTo(map);
                    
                    // O flyTo funcionará para as vagas que tiverem coordenadas válidas.
                    map.flyTo(municipioCoord, 10, { duration: 1.5 });
                }
            }

            function displayTable(vagas) {
                resultsBody.innerHTML = '';
                const fragment = document.createDocumentFragment();
                vagas.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-700 cursor-pointer transition-colors duration-200 hover:bg-slate-800';
                    row.dataset.item = JSON.stringify(item);
                    row.innerHTML = `<td class="p-3">
                                        <p class="font-semibold text-slate-300">${item.cargo}</p>
                                        <a href="${item.link_orgao}" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-400 hover:text-blue-300 hover:underline" tabindex="-1">${item.orgao}</a>
                                     </td>
                                     <td class="p-3 text-right">
                                        <span class="font-bold text-slate-300">[${item.uf}]</span><br>
                                        <span class="text-xs text-slate-500">${item.municipio}</span>
                                     </td>`;
                    
                    row.addEventListener('mouseenter', () => { sfx.playHover(); focusMapOnLocation(item); });
                    row.addEventListener('click', (e) => {
                         window.open(item.link_orgao, '_blank');
                    });

                    fragment.appendChild(row);
                });
                resultsBody.appendChild(fragment);

                tableWrapper.addEventListener('mouseleave', () => {
                    if (selectionMarker) {
                        map.removeLayer(selectionMarker);
                        selectionMarker = null;
                    }
                });

                setupKeyboardNavigation();
            }
            
            function setupKeyboardNavigation() {
                let focusedIndex = -1;
                const rows = Array.from(resultsBody.querySelectorAll('tr'));
                if (rows.length === 0) return;

                const setFocus = (index) => {
                    rows.forEach(r => r.classList.remove('table-row-focus'));
                    const visibleRows = rows.filter(r => r.style.display !== 'none');
                    if(visibleRows.length === 0) { focusedIndex = -1; return; }
                    
                    const newFocusedRow = visibleRows[index];
                    if (!newFocusedRow) return;

                    focusedIndex = rows.indexOf(newFocusedRow);
                    newFocusedRow.classList.add('table-row-focus');
                    newFocusedRow.scrollIntoView({ block: 'nearest' });
                    sfx.playSelect();
                    focusMapOnLocation(JSON.parse(newFocusedRow.dataset.item));
                };

                tableWrapper.addEventListener('keydown', (e) => {
                    const visibleRows = rows.filter(r => r.style.display !== 'none');
                    if (visibleRows.length === 0) return;
                    const currentVisibleIndex = visibleRows.indexOf(rows[focusedIndex]);
                    
                    let nextIndex = currentVisibleIndex;
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        nextIndex = (currentVisibleIndex + 1) % visibleRows.length;
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        nextIndex = (currentVisibleIndex - 1 + visibleRows.length) % visibleRows.length;
                    } else if (e.key === 'Enter' && focusedIndex > -1) {
                        rows[focusedIndex].click();
                    }
                    if (nextIndex !== currentVisibleIndex) {
                       setFocus(nextIndex);
                    }
                });
                
                tableWrapper.addEventListener('focus', () => { if (focusedIndex === -1 && resultsBody.querySelector('tr[style*="display: none;"]') === null) setFocus(0); });
                tableWrapper.addEventListener('blur', () => { rows.forEach(r => r.classList.remove('table-row-focus')); focusedIndex = -1; });
                filterInput.addEventListener('blur', () => tableWrapper.focus());
            }
            
            function filterTable() {
                sfx.playKey();
                const filterText = filterInput.value.toLowerCase();
                const rows = resultsBody.querySelectorAll('tr');
                let visibleRows = 0;
                rows.forEach(row => {
                    const itemData = JSON.parse(row.dataset.item);
                    const rowText = `${itemData.cargo} ${itemData.orgao} ${itemData.uf} ${itemData.municipio}`.toLowerCase();
                    const shouldShow = rowText.includes(filterText);
                    row.style.display = shouldShow ? '' : 'none';
                    if (shouldShow) visibleRows++;
                });
                noResultsMessage.style.display = visibleRows === 0 && data.vagas.length > 0 ? 'block' : 'none';
                setupKeyboardNavigation();
            }

            filterInput.addEventListener('input', filterTable);
            renderAll();
        });
    </script>
</body>
</html>
