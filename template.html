<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Vagas :: Análise Geográfica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #f8fafc; /* Fundo claro */
            --color-panel-bg: #ffffff;
            --color-primary: #2563eb; /* Azul primário */
            --color-secondary: #1e293b; /* Texto escuro */
            --color-text: #475569;   /* Texto secundário */
            --color-border: #e2e8f0;
            --font-title: 'Inter', sans-serif;
            --font-body: 'Inter', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
        }
        body { 
            font-family: var(--font-body);
            background-color: var(--color-bg);
            color: var(--color-text);
        }
        .panel {
            background-color: var(--color-panel-bg);
            border: 1px solid var(--color-border);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border-radius: 0.75rem;
        }
        h1, h2 { font-family: var(--font-title); }
        h1 { color: var(--color-secondary); font-weight: 700; }
        h2 { color: var(--color-primary); font-weight: 500; }
        .monospace { font-family: var(--font-mono); }
        input[type="text"] { 
            background: #f8fafc; 
            border: 1px solid var(--color-border); 
            color: var(--color-secondary);
        }
        input[type="text"]:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
            outline: none;
        }
        .table-row-focus { 
            background-color: rgba(37, 99, 235, 0.05) !important; 
            border-left: 3px solid var(--color-primary);
        }
        .leaflet-container { background: #e2e8f0; border-radius: 0.5rem; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Estilos para a "Mira" (Crosshairs) */
        .crosshair-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 32px;
            height: 32px;
        }
        .crosshair-icon::before, .crosshair-icon::after {
            content: '';
            position: absolute;
            background-color: rgba(37, 99, 235, 0.7); /* Azul primário com transparência */
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
        }
        .crosshair-icon::before { /* Linha Vertical */
            width: 2px;
            height: 40px;
        }
        .crosshair-icon::after { /* Linha Horizontal */
            width: 40px;
            height: 2px;
        }
        .crosshair-dot {
            width: 8px;
            height: 8px;
            background-color: #ffffff;
            border: 2px solid var(--color-primary);
            border-radius: 50%;
            z-index: 1;
        }
    </style>
</head>
<body class="text-slate-600">
    <div class="p-4 sm:p-6 lg:p-8">
        <div class="container mx-auto">
            <header class="text-center mb-10">
                <h1 class="text-3xl md:text-5xl">Painel de Vagas</h1>
                <p class="mt-2 monospace text-sm">Dados extraídos do PCI Concursos</p>
                <p id="last-updated" class="text-xs text-slate-500 mt-2 monospace"></p>
            </header>
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <section class="lg:col-span-3 panel p-4">
                    <h2 class="text-xl mb-4 flex items-center gap-2"><i data-lucide="map-pin"></i>Localização da Vaga</h2>
                    <div id="map" class="h-96 lg:h-[600px] w-full z-0 rounded-lg"></div>
                </section>
                <section class="lg:col-span-2 panel p-4 flex flex-col">
                    <h2 class="text-xl mb-4 flex items-center gap-2"><i data-lucide="list-filter"></i>Vagas Encontradas (<span id="vaga-count">0</span>)</h2>
                    <div class="relative mb-4">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                        <input type="text" id="filterInput" class="w-full pl-10 pr-4 py-2 rounded-md transition" placeholder="Filtrar por cargo, órgão, etc...">
                    </div>
                    <div id="table-wrapper" class="overflow-y-auto flex-grow h-[524px] relative" tabindex="0">
                        <table class="w-full text-left">
                            <tbody id="resultsBody"></tbody>
                        </table>
                        <p id="noResultsMessage" class="text-center p-6" style="display: none;">Nenhum resultado encontrado.</p>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const data = __DATA_PLACEHOLDER__;
            const municipiosCoords = __MUNICIPIOS_COORDS_PLACEHOLDER__;
            
            let map;
            let selectionMarker = null;

            const sfx = {
                synth: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 } }).toDestination(),
                keySynth: new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.1 } }).toDestination(),
                playBoot: () => sfx.synth.triggerAttackRelease("C3", "8n"),
                playKey: () => sfx.keySynth.triggerAttackRelease("C5", "32n"),
                playHover: () => sfx.keySynth.triggerAttackRelease("G4", "32n"),
                playSelect: () => sfx.synth.triggerAttackRelease("A3", "16n")
            };
            const startAudio = () => { if (Tone.context.state !== 'running') { Tone.start(); sfx.playBoot(); document.body.removeEventListener('click', startAudio); document.body.removeEventListener('keydown', startAudio); }};
            document.body.addEventListener('click', startAudio);
            document.body.addEventListener('keydown', startAudio);

            const resultsBody = document.getElementById('resultsBody');
            const tableWrapper = document.getElementById('table-wrapper');
            const filterInput = document.getElementById('filterInput');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const lastUpdatedEl = document.getElementById('last-updated');
            const vagaCountEl = document.getElementById('vaga-count');
            
            function renderAll() {
                if (!data || !data.vagas || typeof data.vagas === 'undefined') {
                    console.error("Dados de vagas ausentes ou em formato incorreto.");
                    vagaCountEl.textContent = 'ERRO';
                    return;
                }
                lastUpdatedEl.textContent = `Última Sincronização: ${data.data_extracao}`;
                vagaCountEl.textContent = data.total_vagas;
                initializeMap();
                displayTable(data.vagas);
                lucide.createIcons();
            }

            function initializeMap() {
                map = L.map('map', { zoomControl: false }).setView([-14.235, -51.925], 4.5);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { 
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>' 
                }).addTo(map);
            }
            
            function focusMapOnLocation(vaga) {
                if(!map) return;
                
                if (selectionMarker) {
                    map.removeLayer(selectionMarker);
                    selectionMarker = null;
                }

                const municipioLimpo = vaga.municipio.replace(/ /g, '-').toLowerCase();
                const key = `${municipioLimpo}-${vaga.uf.toLowerCase()}`;
                const municipioCoord = municipiosCoords[key];
                
                if (municipioCoord) {
                    const crosshairIcon = L.divIcon({
                        className: 'crosshair-icon',
                        html: '<div class="crosshair-dot"></div>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    selectionMarker = L.marker(municipioCoord, { 
                        icon: crosshairIcon,
                        interactive: false // O marcador não captura eventos de mouse
                    }).addTo(map);
                    
                    map.flyTo(municipioCoord, 10, { duration: 1.0 });
                }
            }

            function displayTable(vagas) {
                resultsBody.innerHTML = '';
                const fragment = document.createDocumentFragment();
                vagas.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-200 cursor-pointer hover:bg-blue-50/50';
                    row.dataset.item = JSON.stringify(item);
                    row.innerHTML = `<td class="p-3"><p class="font-semibold text-slate-700">${item.cargo}</p><a href="${item.link_orgao}" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-600 hover:text-blue-800 hover:underline" tabindex="-1">${item.orgao}</a></td><td class="p-3 text-right"><span class="font-bold text-slate-700">[${item.uf}]</span><br><span class="text-xs text-slate-500">${item.municipio}</span></td>`;
                    
                    row.addEventListener('mouseenter', () => { sfx.playHover(); focusMapOnLocation(item); });
                    row.addEventListener('click', (e) => {
                         window.open(item.link_orgao, '_blank');
                    });

                    fragment.appendChild(row);
                });
                resultsBody.appendChild(fragment);

                tableWrapper.addEventListener('mouseleave', () => {
                    if (selectionMarker) {
                        map.removeLayer(selectionMarker);
                        selectionMarker = null;
                    }
                });

                setupKeyboardNavigation();
            }
            
            function setupKeyboardNavigation() {
                let focusedIndex = -1;
                const rows = Array.from(resultsBody.querySelectorAll('tr'));
                if (rows.length === 0) return;

                const setFocus = (index) => {
                    rows.forEach(r => r.classList.remove('table-row-focus'));
                    const visibleRows = rows.filter(r => r.style.display !== 'none');
                    if(visibleRows.length === 0) { focusedIndex = -1; return; }
                    
                    const newFocusedRow = visibleRows[index];
                    if (!newFocusedRow) return;

                    focusedIndex = rows.indexOf(newFocusedRow);
                    newFocusedRow.classList.add('table-row-focus');
                    newFocusedRow.scrollIntoView({ block: 'nearest' });
                    sfx.playSelect();
                    focusMapOnLocation(JSON.parse(newFocusedRow.dataset.item));
                };

                tableWrapper.addEventListener('keydown', (e) => {
                    const visibleRows = rows.filter(r => r.style.display !== 'none');
                    if (visibleRows.length === 0) return;
                    const currentVisibleIndex = visibleRows.indexOf(rows[focusedIndex]);
                    
                    let nextIndex = currentVisibleIndex;
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        nextIndex = (currentVisibleIndex + 1) % visibleRows.length;
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        nextIndex = (currentVisibleIndex - 1 + visibleRows.length) % visibleRows.length;
                    } else if (e.key === 'Enter' && focusedIndex > -1) {
                        rows[focusedIndex].click();
                    }
                    if (nextIndex !== currentVisibleIndex) {
                       setFocus(nextIndex);
                    }
                });
                
                tableWrapper.addEventListener('focus', () => { if (focusedIndex === -1 && resultsBody.querySelector('tr[style*="display: none;"]') === null) setFocus(0); });
                tableWrapper.addEventListener('blur', () => { rows.forEach(r => r.classList.remove('table-row-focus')); focusedIndex = -1; });
                filterInput.addEventListener('blur', () => tableWrapper.focus());
            }
            
            function filterTable() {
                sfx.playKey();
                const filterText = filterInput.value.toLowerCase();
                const rows = resultsBody.querySelectorAll('tr');
                let visibleRows = 0;
                rows.forEach(row => {
                    const itemData = JSON.parse(row.dataset.item);
                    const rowText = `${itemData.cargo} ${itemData.orgao} ${itemData.uf} ${itemData.municipio}`.toLowerCase();
                    const shouldShow = rowText.includes(filterText);
                    row.style.display = shouldShow ? '' : 'none';
                    if (shouldShow) visibleRows++;
                });
                noResultsMessage.style.display = visibleRows === 0 && data.vagas.length > 0 ? 'block' : 'none';
                // Reset focus logic after filtering
                setupKeyboardNavigation();
            }

            filterInput.addEventListener('input', filterTable);
            renderAll();
        });
    </script>
</body>
</html>
